<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roku Bridge Status & Config - Lean</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        :root { --bg-color: #1a1a1a; --surface-color: #2d2d2d; --primary-color: #7dd3fc; --text-color: #e0e0e0; --border-color: #404040; --success-color: #22c55e; --error-color: #ef4444; --button-color: #3b82f6; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background-color: var(--surface-color); border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1, h2 { color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .top-actions { display: flex; gap: 10px; margin-bottom: 20px; }
        .table-wrapper { overflow-x: auto; margin-top: 20px; background: #222; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: #333; }
        .button { background-color: var(--button-color); color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .action-button { padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; color: white; }
        .edit { background-color: #f59e0b; } .delete { background-color: var(--error-color); }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: var(--surface-color); margin: 5% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; max-height: 85vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #1a1a1a; color: white; box-sizing: border-box; }
        #save-all-button { background-color: var(--success-color); width: 100%; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1><span><i class="fa-solid fa-bolt"></i> Roku Bridge Lean <span style="font-size: 0.5em;">v{{ global_settings.app_version }}</span></span></h1>
        
        <div class="top-actions">
            <button class="button" onclick="loadConfig()"><i class="fa-solid fa-sync"></i> Refresh Data</button>
            <a href="/remote" class="button">Remote</a>
            <button id="copy-m3u-btn" class="button" onclick="copyM3uLink()"><i class="fa-solid fa-copy"></i> Copy M3U Link</button>
        </div>

        <h2><i class="fa-solid fa-satellite-dish"></i> LinkPi Tuners</h2>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Name</th><th>Roku IP</th><th>Encoder URL</th><th>Actions</th></tr></thead>
                <tbody id="tuners-body"></tbody>
            </table>
        </div>
        <button class="button" style="margin-top:10px" onclick="openTunerModal()"><i class="fa-solid fa-plus"></i> Add Tuner</button>

        <h2><i class="fa-solid fa-tv"></i> Deep-Link Channels</h2>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Channel Name</th><th>Target App</th><th>Content ID</th><th>Gracenote ID</th><th>Actions</th></tr></thead>
                <tbody id="channels-body"></tbody>
            </table>
        </div>
        <button class="button" style="margin-top:10px" onclick="openChannelModal()"><i class="fa-solid fa-plus"></i> Add Channel</button>

        <button id="save-all-button" class="button" onclick="saveConfig()"><i class="fa-solid fa-save"></i> Save & Reload Server</button>
    </div>

    <div id="tuner-modal" class="modal"><div class="modal-content">
        <h3>Tuner Settings</h3>
        <form id="tuner-form">
            <input type="hidden" id="tuner-index">
            <div class="form-group"><label>Name</label><input type="text" id="t-name" required></div>
            <div class="form-group"><label>Roku IP</label><input type="text" id="t-ip" required></div>
            <div class="form-group"><label>LinkPi TS URL</label><input type="text" id="t-url" required></div>
            <button type="submit" class="button">Apply</button>
            <button type="button" class="button delete" onclick="closeModal('tuner-modal')">Cancel</button>
        </form>
    </div></div>

    <div id="channel-modal" class="modal"><div class="modal-content">
        <h3>Channel Deep-Link Configuration</h3>
        <form id="channel-form">
            <input type="hidden" id="channel-index">
            <div class="form-group"><label>Channel Name (e.g., ESPN)</label><input type="text" id="c-name" required></div>
            <div class="form-group"><label>Channel ID (no spaces, e.g., espn_1)</label><input type="text" id="c-id" required></div>
            
            <div class="form-group">
                <label>Streaming App</label>
                <select id="c-app" required>
                    <option value="195316">YouTube TV</option>
                    <option value="140474">DirecTV Stream</option>
                </select>
            </div>
            
            <div class="form-group"><label>Content ID (The specific video ID to launch)</label><input type="text" id="c-content" required></div>
            <div class="form-group"><label>Gracenote Station ID (For Channels DVR Guide)</label><input type="text" id="c-gracenote" placeholder="e.g. 11594"></div>
            <div class="form-group"><label>Playlist Group (Optional)</label><input type="text" id="c-playlist" placeholder="e.g. Sports"></div>
            <button type="submit" class="button">Apply</button>
            <button type="button" class="button delete" onclick="closeModal('channel-modal')">Cancel</button>
        </form>
    </div></div>

    <script>
        let config = { tuners: [], channels: [] };

        // Helper function to show readable app names in the table
        function getAppName(appId) {
            if (appId === '195316') return 'YouTube TV';
            if (appId === '140474') return 'DirecTV Stream';
            return appId; // Fallback to raw ID if unknown
        }

        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                config = await res.json();
                render();
            } catch (err) { console.error("Error loading config:", err); }
        }

        async function saveConfig() {
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                if (res.ok) alert("Configuration Saved and Server Reloaded!");
                else alert("Error saving configuration.");
            } catch (err) { console.error("Error saving config:", err); }
        }

        function render() {
            document.getElementById('tuners-body').innerHTML = (config.tuners || []).map((t, i) => `
                <tr><td>${t.name}</td><td>${t.roku_ip}</td><td>${t.encoder_url}</td>
                <td><button class="action-button edit" onclick="openTunerModal(${i})">Edit</button>
                <button class="action-button delete" onclick="deleteItem('tuners',${i})">X</button></td></tr>`).join('');
            
            document.getElementById('channels-body').innerHTML = (config.channels || []).map((c, i) => `
                <tr><td>${c.name}</td><td>${getAppName(c.roku_app_id)}</td><td>${c.deep_link_content_id}</td><td>${c.gracenote_id || '-'}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <a href="/preview/${c.id}" class="action-button" title="Preview Stream" style="background-color: #8b5cf6; text-decoration: none; padding: 6px 10px; display: inline-flex; align-items: center; justify-content: center;"><i class="fa-solid fa-play"></i></a>
                        <button class="action-button edit" onclick="openChannelModal(${i})">Edit</button>
                        <button class="action-button delete" onclick="deleteItem('channels',${i})">X</button>
                    </div>
                </td></tr>`).join('');
        }

        function openTunerModal(idx = null) {
            document.getElementById('tuner-index').value = idx !== null ? idx : "";
            if(idx !== null) {
                const t = config.tuners[idx];
                document.getElementById('t-name').value = t.name;
                document.getElementById('t-ip').value = t.roku_ip;
                document.getElementById('t-url').value = t.encoder_url;
            } else { document.getElementById('tuner-form').reset(); }
            document.getElementById('tuner-modal').style.display = 'block';
        }

        document.getElementById('tuner-form').onsubmit = (e) => {
            e.preventDefault();
            const idx = document.getElementById('tuner-index').value;
            const data = {
                name: document.getElementById('t-name').value,
                roku_ip: document.getElementById('t-ip').value,
                encoder_url: document.getElementById('t-url').value
            };
            if(idx !== "") config.tuners[idx] = data; else config.tuners.push(data);
            render(); closeModal('tuner-modal');
        }

        function openChannelModal(idx = null) {
            document.getElementById('channel-index').value = idx !== null ? idx : "";
            if(idx !== null) {
                const c = config.channels[idx];
                document.getElementById('c-name').value = c.name;
                document.getElementById('c-id').value = c.id;
                
                // Set the dropdown value safely
                let appSelect = document.getElementById('c-app');
                if (Array.from(appSelect.options).some(opt => opt.value === c.roku_app_id)) {
                    appSelect.value = c.roku_app_id;
                } else {
                    appSelect.value = "195316"; // Default to YTTV if missing
                }
                
                document.getElementById('c-content').value = c.deep_link_content_id;
                document.getElementById('c-gracenote').value = c.gracenote_id || "";
                document.getElementById('c-playlist').value = c.playlist || "";
            } else { 
                document.getElementById('channel-form').reset(); 
                document.getElementById('c-app').value = "195316"; // Set default for new channels
            }
            document.getElementById('channel-modal').style.display = 'block';
        }

        document.getElementById('channel-form').onsubmit = (e) => {
            e.preventDefault();
            const idx = document.getElementById('channel-index').value;
            const data = {
                name: document.getElementById('c-name').value,
                id: document.getElementById('c-id').value,
                roku_app_id: document.getElementById('c-app').value, // Gets the value from the dropdown
                deep_link_content_id: document.getElementById('c-content').value,
                gracenote_id: document.getElementById('c-gracenote').value,
                playlist: document.getElementById('c-playlist').value
            };
            if(idx !== "") config.channels[idx] = data; else config.channels.push(data);
            render(); closeModal('channel-modal');
        }

        function deleteItem(key, idx) { if(confirm("Are you sure?")) { config[key].splice(idx, 1); render(); } }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onload = loadConfig;
		
		// Copy M3U Link to Clipboard (With HTTP Network Fallback)
        async function copyM3uLink() {
            const m3uUrl = window.location.origin + '/channels.m3u';
            
            try {
                // Try modern API first (works on localhost)
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(m3uUrl);
                } else {
                    // Fallback for HTTP network IPs
                    const textArea = document.createElement("textarea");
                    textArea.value = m3uUrl;
                    // Hide the text area off-screen
                    textArea.style.position = "fixed";
                    textArea.style.left = "-999999px";
                    textArea.style.top = "-999999px";
                    document.body.appendChild(textArea);
                    
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (!successful) throw new Error('Fallback copy command failed');
                }
                
                // Visual feedback: Temporarily change the button text
                const btn = document.getElementById('copy-m3u-btn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                btn.style.backgroundColor = 'var(--success-color)';
                
                // Revert back after 2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.style.backgroundColor = 'var(--button-color)';
                }, 2000);
                
            } catch (err) {
                console.error('Failed to copy:', err);
                alert("Failed to copy link. Your browser is strictly blocking clipboard access.");
            }
        }
    </script>
</body>
</html>